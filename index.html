<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰¹æ–¯æ‹‰(TSLA)æ¨¡æ‹Ÿäº¤æ˜“ç­–ç•¥è·Ÿè¸ª</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        #globalWarning {
            background: linear-gradient(90deg, #ff3b30, #ff6b6b);
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        #globalWarning button {
            margin-left: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 2px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 2.8rem;
            background: linear-gradient(90deg, #00c9ff, #92fe9d);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            background: rgba(40, 40, 40, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #4cd964;
            text-shadow: 0 0 10px rgba(76, 217, 100, 0.3);
        }

        .stat-label {
            font-size: 1rem;
            color: #aaa;
            margin-top: 5px;
        }

        .chart-container {
            display: flex;
            margin-bottom: 30px;
        }

        .chart-box {
            flex: 1;
            background: rgba(40, 40, 40, 0.8);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chart-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #fff;
            text-align: center;
        }

        .chart-title i {
            color: #4cd964;
        }

        .chart {
            height: 500px;
            width: 100%;
        }

        .data-table-container {
            background: rgba(40, 40, 40, 0.8);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 1.4rem;
            color: #fff;
            text-align: center;
            width: 100%;
        }

        .update-info {
            color: #aaa;
            font-size: 0.9rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: rgba(0, 0, 0, 0.5);
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            color: #fff;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .data-table td {
            padding: 14px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .buy-operation {
            color: #ff3b30;
            background: rgba(255, 59, 48, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .sell-operation {
            color: #4cd964;
            background: rgba(76, 217, 100, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .positive-pnl {
            color: #4cd964;
        }

        .negative-pnl {
            color: #ff3b30;
        }

        .auto-update-status {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            font-size: 0.9rem;
            color: #aaa;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4cd964;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(76, 217, 100, 0.3);
            border-radius: 50%;
            border-top-color: #4cd964;
            animation: spin 1s linear infinite;
        }

        .error-message {
            background: rgba(255, 59, 48, 0.2);
            border: 1px solid rgba(255, 59, 48, 0.3);
            color: #ff3b30;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .error-message h3 {
            margin-bottom: 10px;
        }

        .error-message button {
            background: rgba(76, 217, 100, 0.2);
            border: 1px solid rgba(76, 217, 100, 0.3);
            color: #4cd964;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }

        .timestamp-display {
            color: #aaa;
            font-size: 0.85rem;
        }

        .disclaimer-footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #777;
            font-size: 0.85rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .disclaimer-footer p {
            margin-top: 2px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.5;
        }

        #disclaimerModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            padding: 20px;
        }

        .modal-content {
            background: #2a2a2a;
            max-width: 1000px; /* â† è°ƒæ•´è¿™ä¸ªå€¼æ§åˆ¶æœ€å¤§å®½åº¦ */
            width: 90%; /* â† è°ƒæ•´è¿™ä¸ªå€¼æ§åˆ¶å®½åº¦ç™¾åˆ†æ¯” */
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            color: #fff;
            position: relative;
            max-height: 800px; /* â† è°ƒæ•´è¿™ä¸ªå€¼æ§åˆ¶æœ€å¤§é«˜åº¦ */
            display: flex;
            flex-direction: column;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 24px; /* åŠ å¤§å…³é—­æŒ‰é’® */
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .modal-title {
            color: #ff3b30;
            margin-bottom: 20px;
            font-size: 1.8rem; /* åŠ å¤§æ ‡é¢˜ */
        }

        .modal-body {
            line-height: 1.6;
            overflow-y: auto;
            padding-right: 10px;
            flex: 1;
        }

        .modal-body p {
            margin-bottom: 15px;
            font-size: 1.1rem; /* åŠ å¤§å­—ä½“ */
        }

        .modal-body strong {
            color: #4cd964;
            font-weight: 600;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .chart-container {
                flex-direction: column;
            }
            .stats-bar {
                flex-wrap: wrap;
            }
            .stat-item {
                flex: 0 0 33.33%;
                margin-bottom: 15px;
            }
            h1 {
                font-size: 2.2rem;
            }
            .chart {
                height: 400px;
            }
            .auto-update-status {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            .modal-content {
                width: 95%;
                max-height: 80vh;
                padding: 20px;
            }
            .modal-title {
                font-size: 1.5rem;
            }
            .modal-body p {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- é¡µé¢é¡¶éƒ¨è­¦å‘Šæ¡ -->
    <div id="globalWarning">
        <i class="fas fa-exclamation-circle"></i>
        <strong>æ¨¡æ‹Ÿäº¤æ˜“å›æµ‹ç³»ç»Ÿ - ä¸æ„æˆæŠ•èµ„å»ºè®®</strong>
        <button onclick="showDisclaimerModal()">æŸ¥çœ‹å®Œæ•´å£°æ˜</button>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: flex;">
        <div class="loading-spinner"></div>
        <div style="color: #4cd964; margin-left: 20px;">æ­£åœ¨åŠ è½½æ•°æ®...</div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <header>
            <!-- ç§»é™¤äº†æ ‡é¢˜å‰é¢çš„å›¾æ ‡ -->
            <h1>ç‰¹æ–¯æ‹‰(TSLA)æ¨¡æ‹Ÿäº¤æ˜“ç­–ç•¥è·Ÿè¸ª</h1>
            <div class="auto-update-status">
                <span class="status-indicator"></span>
                <span>æœ€åæ›´æ–°: <span id="lastUpdateTime" class="timestamp-display">åŠ è½½ä¸­...</span></span>
            </div>
        </header>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="totalPnl">-</div>
                <div class="stat-label">æ€»æ”¶ç›Š</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="maxDrawdown">-</div>
                <div class="stat-label">æœ€å¤§å›æ’¤</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="maxDrawdownDays">-</div>
                <div class="stat-label">æœ€å¤§å›æ’¤å¤©æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalPositions">-</div>
                <div class="stat-label">æŒä»“æ•°é‡</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="tradeCount">-</div>
                <div class="stat-label">äº¤æ˜“æ¬¡æ•°</div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-box">
                <div class="chart-title">
                    <span><i class="fas fa-chart-candlestick"></i> ä»·æ ¼ä¸æ”¶ç›Š</span>
                </div>
                <div id="combinedChart" class="chart"></div>
            </div>
        </div>

        <div class="data-table-container">
            <div class="table-header">
                <h2 class="table-title">äº¤æ˜“è®°å½•</h2>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ (ç¾ä¸œæ—¶é—´)</th>
                        <th>å¼€ç›˜ä»·</th>
                        <th>æœ€é«˜ä»·</th>
                        <th>æœ€ä½ä»·</th>
                        <th>æ”¶ç›˜ä»·</th>
                        <th>æ“ä½œ</th>
                        <th>ç­–ç•¥</th>
                        <th>æŒä»“</th>
                        <th>ä»·æ ¼</th>
                        <th>å‡€å€¼</th>
                    </tr>
                </thead>
                <tbody id="tradeData">
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px;">æ­£åœ¨åŠ è½½äº¤æ˜“æ•°æ®...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="disclaimer-footer">
            <p>ç‰¹æ–¯æ‹‰(TSLA)æ¨¡æ‹Ÿäº¤æ˜“ç­–ç•¥è·Ÿè¸ª &copy; 2026</p>
            <p>
                <strong>é£é™©æç¤ºï¼š</strong>æœ¬å¹³å°æ‰€æœ‰æ•°æ®å‡ä¸ºæ¨¡æ‹Ÿå›æµ‹ç»“æœï¼Œä»…ä¾›ç ”ç©¶å‚è€ƒï¼Œå®é™…æŠ•èµ„å¯èƒ½å­˜åœ¨é‡å¤§å·®å¼‚ã€‚
            </p>
            <p>
                è‚¡å¸‚æŠ•èµ„å…·æœ‰é«˜é£é™©æ€§ï¼Œå¯èƒ½å¯¼è‡´æœ¬é‡‘æŸå¤±ã€‚æŠ•èµ„è€…åº”å……åˆ†äº†è§£ç›¸å…³é£é™©ï¼Œè°¨æ…å†³ç­–ã€‚å¹³å°ä¸å¯¹ä»»ä½•æŠ•èµ„å†³ç­–æˆ–ç»“æœè´Ÿè´£ã€‚
        </div>
    </div>

    <!-- å…è´£å£°æ˜æ¨¡æ€æ¡†ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ -->
    <div id="disclaimerModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeDisclaimerModal()">âœ•</button>

            <h3 class="modal-title">
                <i class="fas fa-exclamation-triangle"></i> å…è´£å£°æ˜
            </h3>

            <div class="modal-body">
                <p><strong>1. æ€§è´¨è¯´æ˜</strong> æœ¬å¹³å°ä¸ºç‰¹æ–¯æ‹‰(TSLA)è‚¡ç¥¨çš„æ¨¡æ‹Ÿäº¤æ˜“ç­–ç•¥å›æµ‹å·¥å…·ï¼Œæ‰€æœ‰äº¤æ˜“å‡ä¸ºè™šæ‹Ÿæ¨¡æ‹Ÿï¼Œä¸æ¶‰åŠçœŸå®èµ„é‡‘ã€‚</p>

                <p><strong>2. éæŠ•èµ„å»ºè®®</strong> æ‰€æœ‰å±•ç¤ºçš„ç­–ç•¥ã€æ•°æ®å’Œå›¾è¡¨ä»…ä¸ºå†å²å›æµ‹ç»“æœï¼Œä¸æ„æˆä»»ä½•å½¢å¼çš„æŠ•èµ„å»ºè®®ã€æ¨èæˆ–æ‰¿è¯ºã€‚</p>

                <p><strong>3. é£é™©è­¦ç¤º</strong> å®é™…è‚¡ç¥¨å¸‚åœºæŠ•èµ„å…·æœ‰é«˜é£é™©ï¼Œå¯èƒ½å¯¼è‡´æœ¬é‡‘å…¨éƒ¨æŸå¤±ã€‚è¿‡å»è¡¨ç°ä¸ä»£è¡¨æœªæ¥æ”¶ç›Šã€‚</p>

                <p><strong>4. æ•°æ®å…è´£</strong> å¹³å°æ•°æ®æ¥æºäºå…¬å¼€å¸‚åœºä¿¡æ¯ï¼Œä¸ä¿è¯å‡†ç¡®æ€§ã€å®Œæ•´æ€§æˆ–åŠæ—¶æ€§ã€‚æ•°æ®ä»…ä¾›å‚è€ƒã€‚</p>

                <p><strong>5. è´£ä»»é™åˆ¶</strong> å¹³å°æ‰€æœ‰è€…ã€å¼€å‘è€…åŠç›¸å…³æ–¹ä¸å¯¹å› ä½¿ç”¨æœ¬å¹³å°æ•°æ®å¯¼è‡´çš„ä»»ä½•æŠ•èµ„æŸå¤±æ‰¿æ‹…è´£ä»»ã€‚</p>

                <p><strong>6. ç”¨æˆ·è´£ä»»</strong> ç”¨æˆ·åº”ç‹¬ç«‹åˆ¤æ–­ï¼Œè‡ªè´ŸæŠ•èµ„é£é™©ã€‚å»ºè®®å’¨è¯¢æŒç‰ŒæŠ•èµ„é¡¾é—®ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let chartInstance = null;
        let currentData = null;
        let dataVersion = "1.0.0";  // é»˜è®¤ç‰ˆæœ¬å·ï¼Œç”¨äºæ§åˆ¶å°è¾“å‡º

        // å…è´£å£°æ˜ç›¸å…³
        function showDisclaimerModal() {
            document.getElementById('disclaimerModal').style.display = 'block';
        }

        function closeDisclaimerModal() {
            document.getElementById('disclaimerModal').style.display = 'none';
            // è®¾ç½®cookieï¼Œ24å°æ—¶å†…ä¸å†æ˜¾ç¤º
            document.cookie = "disclaimer_closed=true; max-age=86400; path=/";
        }

        // æ£€æŸ¥æ˜¯å¦å·²å…³é—­è¿‡å…è´£å£°æ˜
        function checkDisclaimer() {
            if (!document.cookie.includes('disclaimer_closed=true')) {
                setTimeout(() => {
                    document.getElementById('disclaimerModal').style.display = 'block';
                }, 1000);
            }
        }

        // è·å–æ•°æ®æ–‡ä»¶ URL - æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
        const getDataFileUrl = () => {
            // æ¯æ¬¡è¯·æ±‚éƒ½å¸¦ä¸Šå½“å‰æ—¶é—´æˆ³ï¼Œç¡®ä¿è·å–æœ€æ–°æ•°æ®
            return `./data.json?t=${Date.now()}`;
        };

        // æ˜¾ç¤º/éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
            }
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <h3><i class="fas fa-exclamation-triangle"></i> åŠ è½½æ•°æ®å¤±è´¥</h3>
                <p>${message}</p>
                <button onclick="location.reload()">åˆ·æ–°é¡µé¢</button>
            `;
            document.body.appendChild(errorDiv);
            showLoading(false);
        }

        // åŠ è½½JSONæ•°æ®
        async function loadJSON(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                throw error;
            }
        }

        // ä»tradesæ•°æ®ç”ŸæˆKçº¿æ•°æ®
        function generateKlineFromTrades(trades) {
            if (!trades || trades.length === 0) {
                return [];
            }

            // æŒ‰æ—¶é—´æ’åºï¼ˆä»æ—©åˆ°æ™šï¼‰
            const sortedTrades = [...trades].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });

            // è½¬æ¢ä¸ºKçº¿æ ¼å¼ï¼š[æ—¶é—´, å¼€ç›˜ä»·, æœ€é«˜ä»·, æœ€ä½ä»·, æ”¶ç›˜ä»·]
            const klineData = sortedTrades.map(trade => {
                const dateStr = trade.date;
                let formattedDate = dateStr;

                if (dateStr && dateStr.length === 15) {
                    try {
                        const datePart = dateStr.substring(0, 8);
                        const timePart = dateStr.substring(9);
                        const year = datePart.substring(0, 4);
                        const month = datePart.substring(4, 6);
                        const day = datePart.substring(6, 8);
                        formattedDate = `${year}-${month}-${day} ${timePart}`;
                    } catch (e) {
                        console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', e);
                    }
                }

                return [
                    formattedDate,
                    Number(trade.open) || 0,  // å¼€ç›˜ä»·
                    Number(trade.high) || 0,  // æœ€é«˜ä»·
                    Number(trade.low) || 0,   // æœ€ä½ä»·
                    Number(trade.close) || 0  // æ”¶ç›˜ä»·
                ];
            });

            return klineData;
        }

        // ä»tradesæ•°æ®ç”Ÿæˆå‡€å€¼(equity)æ•°æ® - ç”¨äºå›¾è¡¨
        function generateEquityData(trades) {
            if (!trades || trades.length === 0) {
                return [];
            }

            // æŒ‰æ—¶é—´æ’åºï¼ˆä»æ—©åˆ°æ™šï¼‰
            const sortedTrades = [...trades].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });

            // è½¬æ¢ä¸ºå‡€å€¼æ ¼å¼ï¼š[æ—¶é—´, å‡€å€¼] - ä½¿ç”¨æ‰€æœ‰äº¤æ˜“è®°å½•
            const equityData = sortedTrades.map(trade => {
                const dateStr = trade.date;
                let formattedDate = dateStr;

                if (dateStr && dateStr.length === 15) {
                    try {
                        const datePart = dateStr.substring(0, 8);
                        const timePart = dateStr.substring(9);
                        const year = datePart.substring(0, 4);
                        const month = datePart.substring(4, 6);
                        const day = datePart.substring(6, 8);
                        formattedDate = `${year}-${month}-${day} ${timePart}`;
                    } catch (e) {
                        console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', e);
                    }
                }

                return [
                    formattedDate,
                    Number(trade.equity) || 0
                ];
            });

            return equityData;
        }

        // ä»tradesæ•°æ®ç”Ÿæˆæ¯æ—¥ç»“æŸæ—¶çš„å‡€å€¼æ•°æ®ï¼ˆç”¨äºè®¡ç®—æœ€å¤§å›æ’¤ï¼‰
        function generateDailyEquityData(trades) {
            if (!trades || trades.length === 0) {
                return [];
            }

            // æŒ‰æ—¶é—´æ’åºï¼ˆä»æ—©åˆ°æ™šï¼‰
            const sortedTrades = [...trades].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });

            // æŒ‰æ—¥æœŸåˆ†ç»„ï¼Œå–æ¯æ—¥æœ€åä¸€æ¡è®°å½•çš„å‡€å€¼
            const dailyEquityMap = new Map();

            sortedTrades.forEach(trade => {
                const dateStr = trade.date;
                let dateKey = '';

                if (dateStr) {
                    // æ ¼å¼1: "20260102 10:00:00" (15ä¸ªå­—ç¬¦)
                    if (dateStr.length === 15) {
                        try {
                            const datePart = dateStr.substring(0, 8);
                            const year = datePart.substring(0, 4);
                            const month = datePart.substring(4, 6);
                            const day = datePart.substring(6, 8);
                            dateKey = `${year}-${month}-${day}`;
                        } catch (e) {
                            console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', e);
                        }
                    }
                    // æ ¼å¼2: "2026-01-02 10:00:00" (19ä¸ªå­—ç¬¦)
                    else if (dateStr.length >= 10) {
                        try {
                            dateKey = dateStr.substring(0, 10);
                        } catch (e) {
                            console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', e);
                        }
                    }
                }

                if (dateKey) {
                    dailyEquityMap.set(dateKey, {
                        date: dateKey,
                        equity: Number(trade.equity) || 0
                    });
                }
            });

            // è½¬æ¢ä¸ºå‡€å€¼æ ¼å¼ï¼š[æ—¥æœŸ, å‡€å€¼]
            const equityData = Array.from(dailyEquityMap.values())
                .sort((a, b) => a.date.localeCompare(b.date))
                .map(item => [item.date, item.equity]);

            return equityData;
        }

        // ä»å‡€å€¼æ•°æ®ç”Ÿæˆæ”¶ç›Šç™¾åˆ†æ¯”æ•°æ®
        function generateReturnsFromEquity(equityData) {
            if (!equityData || equityData.length === 0) {
                return [];
            }

            // è®¡ç®—åˆå§‹å‡€å€¼ï¼ˆç¬¬ä¸€ä¸ªå‡€å€¼ï¼‰
            const initialEquity = equityData[0][1];
            if (initialEquity <= 0) {
                return [];
            }

            // è½¬æ¢ä¸ºæ”¶ç›Šæ ¼å¼ï¼š[æ—¶é—´, æ”¶ç›Šç™¾åˆ†æ¯”]
            const returnsData = equityData.map(item => {
                const currentEquity = item[1];
                const returnPercent = ((currentEquity - initialEquity) / initialEquity * 100);

                return [
                    item[0],
                    parseFloat(returnPercent.toFixed(2))
                ];
            });

            return returnsData;
        }

        // è®¡ç®—æœ€å¤§å›æ’¤ï¼ˆåŸºäºæ¯æ—¥ç»“æŸæ—¶çš„å‡€å€¼æ•°æ®ï¼‰
        function calculateMaxDrawdownFromEquity(dailyEquityData) {
            if (!dailyEquityData || dailyEquityData.length < 2) {
                return { maxDrawdownPercent: 0, maxDrawdownDays: 0 };
            }

            let peak = dailyEquityData[0][1];
            let maxDrawdown = 0;
            let peakDate = dailyEquityData[0][0];
            let drawdownStartDate = dailyEquityData[0][0];
            let drawdownEndDate = dailyEquityData[0][0];

            for (let i = 1; i < dailyEquityData.length; i++) {
                const currentEquity = dailyEquityData[i][1];
                const currentDate = dailyEquityData[i][0];

                if (currentEquity > peak) {
                    peak = currentEquity;
                    peakDate = currentDate;
                } else {
                    const drawdown = (peak - currentEquity) / peak * 100;

                    if (drawdown > maxDrawdown) {
                        maxDrawdown = drawdown;
                        drawdownStartDate = peakDate;
                        drawdownEndDate = currentDate;
                    }
                }
            }

            // è®¡ç®—æœ€å¤§å›æ’¤å¤©æ•°
            let maxDrawdownDays = 0;
            try {
                const startDate = new Date(drawdownStartDate);
                const endDate = new Date(drawdownEndDate);
                const timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
                maxDrawdownDays = Math.ceil(timeDiff / (1000 * 3600 * 24));

                if (isNaN(maxDrawdownDays) || maxDrawdownDays < 0) {
                    maxDrawdownDays = 0;
                }
            } catch (e) {
                console.error('è®¡ç®—æœ€å¤§å›æ’¤å¤©æ•°é”™è¯¯:', e);
                maxDrawdownDays = 0;
            }

            return {
                maxDrawdownPercent: maxDrawdown.toFixed(2),
                maxDrawdownDays: maxDrawdownDays
            };
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
        function formatDate(dateStr) {
            if (!dateStr) return '';

            try {
                if (dateStr.length === 15) {
                    const datePart = dateStr.substring(0, 8);
                    const timePart = dateStr.substring(9);
                    const year = datePart.substring(0, 4);
                    const month = datePart.substring(4, 6);
                    const day = datePart.substring(6, 8);
                    return `${year}-${month}-${day} ${timePart}`;
                }
                return dateStr;
            } catch (e) {
                console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', e);
                return dateStr;
            }
        }

        // åˆå§‹åŒ–åˆå¹¶å›¾è¡¨
        function initCombinedChart(klineData, returnsData) {
            const chartDom = document.getElementById('combinedChart');
            if (!chartDom) {
                return null;
            }

            if (chartInstance) {
                chartInstance.dispose();
            }

            chartInstance = echarts.init(chartDom);

            if (!klineData || klineData.length === 0) {
                chartDom.innerHTML = '<div style="color: #aaa; text-align: center; padding: 50px;">æš‚æ— å›¾è¡¨æ•°æ®</div>';
                return null;
            }

            // å‡†å¤‡Kçº¿æ•°æ® - æŒ‰ç…§ECharts candlestickè¦æ±‚çš„é¡ºåºï¼š[å¼€ç›˜ä»·, æ”¶ç›˜ä»·, æœ€ä½ä»·, æœ€é«˜ä»·]
            const klineSeriesData = klineData.map(item => [
                item[1] || 0, // å¼€ç›˜ä»·
                item[4] || 0, // æ”¶ç›˜ä»·
                item[3] || 0, // æœ€ä½ä»·
                item[2] || 0  // æœ€é«˜ä»·
            ]);

            const timeData = klineData.map(item => item[0] || '');

            // å‡†å¤‡æ”¶ç›Šæ•°æ®
            let returnsSeriesData = [];
            if (returnsData && returnsData.length > 0) {
                returnsSeriesData = returnsData.map(item => item[1] || 0);
            }

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    textStyle: {
                        color: '#fff'
                    },
                    formatter: function(params) {
                        let result = '';
                        params.forEach(param => {
                            if (param.seriesType === 'candlestick') {
                                const dataIndex = param.dataIndex;
                                result += `${timeData[dataIndex]}<br/>`;
                                // ä»è°ƒè¯•æˆªå›¾å¯çŸ¥ï¼Œparam.valueåŒ…å«5ä¸ªå€¼ï¼š[ç´¢å¼•, å¼€ç›˜ä»·, æœ€é«˜ä»·, æœ€ä½ä»·, æ”¶ç›˜ä»·]
                                // ç´¢å¼•æ˜¯ç¬¬0ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬è·³è¿‡å®ƒï¼Œä»ç¬¬1ä¸ªå¼€å§‹æ˜¯ä»·æ ¼æ•°æ®
                                result += `å¼€ç›˜: ${param.value[1]}<br/>`;
                                result += `æœ€é«˜: ${param.value[4]}<br/>`;
                                result += `æœ€ä½: ${param.value[3]}<br/>`;
                                result += `æ”¶ç›˜: ${param.value[2]}<br/>`;
                            } else if (param.seriesType === 'line') {
                                result += `æ”¶ç›Š: ${param.value.toFixed(2)}%<br/>`;
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['ä»·æ ¼', 'æ”¶ç›Š'],
                    textStyle: {
                        color: '#aaa'
                    },
                    top: 10
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '8%',
                    top: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: timeData,
                    axisLine: {
                        lineStyle: {
                            color: '#aaa'
                        }
                    },
                    axisLabel: {
                        color: '#aaa',
                        fontSize: 10,
                        formatter: function(value) {
                            if (!value) return '';
                            const parts = value.split(' ');
                            if (parts.length > 1) {
                                return parts[0];
                            }
                            return value;
                        }
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        scale: true,
                        name: 'ä»·æ ¼',
                        nameTextStyle: {
                            color: '#aaa'
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#aaa'
                            }
                        },
                        axisLabel: {
                            color: '#aaa',
                            formatter: '{value}'
                        },
                        splitLine: {
                            lineStyle: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                type: 'dashed'
                            }
                        }
                    },
                    {
                        type: 'value',
                        scale: true,
                        name: 'æ”¶ç›Š(%)',
                        nameTextStyle: {
                            color: '#aaa'
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#aaa'
                            }
                        },
                        axisLabel: {
                            color: '#aaa',
                            formatter: '{value}%'
                        },
                        splitLine: {
                            show: false
                        },
                        position: 'right'
                    }
                ],
                series: [
                    {
                        name: 'ä»·æ ¼',
                        type: 'candlestick',
                        data: klineSeriesData,
                        itemStyle: {
                            color: '#ff3b30',
                            color0: '#4cd964',
                            borderColor: '#ff3b30',
                            borderColor0: '#4cd964',
                            borderWidth: 1
                        },
                        // åœ¨è¿™é‡Œæ·»åŠ å®½åº¦æ§åˆ¶å‚æ•°
                        yAxisIndex: 0
                    },
                    {
                        name: 'æ”¶ç›Š',
                        type: 'line',
                        yAxisIndex: 1,
                        data: returnsSeriesData,
                        smooth: true,
                        lineStyle: {
                            width: 3,
                            color: '#00c9ff'
                        },
                        itemStyle: {
                            color: '#00c9ff'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(0, 201, 255, 0.5)' },
                                { offset: 1, color: 'rgba(0, 201, 255, 0.1)' }
                            ])
                        }
                    }
                ]
            };

            chartInstance.setOption(option);

            // å“åº”çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', function() {
                chartInstance.resize();
            });

            return chartInstance;
        }

        // æ¸²æŸ“äº¤æ˜“è®°å½•è¡¨æ ¼ - ä¿®æ­£ï¼šæŒ‰æ—¶é—´é¡ºåºè¿‡æ»¤é‡å¤é¡¹
        function renderTradeTable(tradeRecords) {
            const tableBody = document.getElementById('tradeData');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            if (!tradeRecords || tradeRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">æš‚æ— äº¤æ˜“æ•°æ®</td></tr>';
                return;
            }

            console.log('æ¸²æŸ“äº¤æ˜“è¡¨æ ¼ï¼ŒåŸå§‹è®°å½•æ•°é‡:', tradeRecords.length);

            // ä¿®å¤ï¼šå…ˆæŒ‰æ—¶é—´ä»æ—©åˆ°æ™šæ’åºï¼Œä»¥ç¡®ä¿æˆ‘ä»¬æŒ‰å®é™…äº¤æ˜“é¡ºåºè¿‡æ»¤
            const timeSortedTrades = [...tradeRecords].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });

            // è¿‡æ»¤é‡å¤é¡¹ï¼šä»¥æ“ä½œ(operation)å’ŒæŒä»“(position)ä¸ºå‡†
            const uniqueRecords = [];

            for (let i = 0; i < timeSortedTrades.length; i++) {
                const currentRecord = timeSortedTrades[i];

                // å¦‚æœæ˜¯ç¬¬ä¸€æ¡è®°å½•ï¼Œæ€»æ˜¯æ·»åŠ 
                if (i === 0) {
                    uniqueRecords.push(currentRecord);
                    continue;
                }

                const prevRecord = timeSortedTrades[i - 1];

                // å¦‚æœæ“ä½œæˆ–ä»“ä½æœ‰å˜åŒ–ï¼Œæ·»åŠ åˆ°ç»“æœä¸­
                if (currentRecord.operation !== prevRecord.operation ||
                    currentRecord.position !== prevRecord.position) {
                    uniqueRecords.push(currentRecord);
                }
                // å¦åˆ™ï¼Œæ“ä½œå’Œä»“ä½éƒ½æ²¡å˜åŒ–ï¼Œè·³è¿‡è¿™æ¡è®°å½•
            }

            console.log('è¿‡æ»¤åè®°å½•æ•°é‡ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰:', uniqueRecords.length);

            // æŒ‰æ—¥æœŸé™åºæ’åˆ—ç”¨äºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼‰
            const displayRecords = [...uniqueRecords].sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });

            displayRecords.forEach(record => {
                const row = document.createElement('tr');
                const operationClass = record.operation === 'BUY' ? 'buy-operation' : 'sell-operation';

                row.innerHTML = `
                    <td>${formatDate(record.date)}</td>
                    <td>${record.open !== undefined ? Number(record.open).toFixed(2) : '-'}</td>
                    <td>${record.high !== undefined ? Number(record.high).toFixed(2) : '-'}</td>
                    <td>${record.low !== undefined ? Number(record.low).toFixed(2) : '-'}</td>
                    <td>${record.close !== undefined ? Number(record.close).toFixed(2) : '-'}</td>
                    <td><span class="${operationClass}">${record.operation || '-'}</span></td>
                    <td>${record.strategy || '-'}</td>
                    <td>${record.position !== undefined ? record.position : '-'}</td>
                    <td>${record.price !== undefined ? Number(record.price).toFixed(2) : '-'}</td>
                    <td>${record.equity !== undefined ? Number(record.equity).toFixed(2) : '-'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats(tradeRecords, equityData, dailyEquityData) {
            if (!tradeRecords || tradeRecords.length === 0) {
                ['totalPnl', 'maxDrawdown', 'maxDrawdownDays', 'totalPositions', 'tradeCount'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = '-';
                });
                return;
            }

            // æŒ‰æ—¶é—´æ’åºï¼ˆä»æ—©åˆ°æ™šï¼‰
            const sortedTrades = [...tradeRecords].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });

            const firstRecord = sortedTrades[0];
            const latestRecord = sortedTrades[sortedTrades.length - 1];

            // æ›´æ–°æ€»æ”¶ç›Š - ä»equityè®¡ç®—
            if (firstRecord.equity !== undefined && latestRecord.equity !== undefined) {
                const pnlEl = document.getElementById('totalPnl');
                if (pnlEl) {
                    const initialEquity = Number(firstRecord.equity);
                    const latestEquity = Number(latestRecord.equity);

                    if (initialEquity > 0) {
                        const totalReturn = ((latestEquity - initialEquity) / initialEquity * 100);
                        pnlEl.textContent = totalReturn.toFixed(2) + '%';
                    } else {
                        pnlEl.textContent = '0.00%';
                    }
                }
            }

            // æ›´æ–°æŒä»“æ•°é‡
            if (latestRecord.position !== undefined) {
                const positionsEl = document.getElementById('totalPositions');
                if (positionsEl) {
                    positionsEl.textContent = latestRecord.position.toString();
                }
            }

            // æ›´æ–°äº¤æ˜“æ¬¡æ•° - ä½¿ç”¨è¿‡æ»¤åçš„è®°å½•æ•°é‡
            const tradeCountEl = document.getElementById('tradeCount');
            if (tradeCountEl) {
                // ä½¿ç”¨æ–°çš„è¿‡æ»¤é€»è¾‘è®¡ç®—äº¤æ˜“æ¬¡æ•°
                const uniqueRecords = [];
                const timeSortedTrades = [...tradeRecords].sort((a, b) => {
                    return new Date(a.date) - new Date(b.date);
                });

                for (let i = 0; i < timeSortedTrades.length; i++) {
                    const currentRecord = timeSortedTrades[i];

                    if (i === 0) {
                        uniqueRecords.push(currentRecord);
                        continue;
                    }

                    const prevRecord = timeSortedTrades[i - 1];

                    if (currentRecord.operation !== prevRecord.operation ||
                        currentRecord.position !== prevRecord.position) {
                        uniqueRecords.push(currentRecord);
                    }
                }

                tradeCountEl.textContent = uniqueRecords.length.toString();
            }

            // æ›´æ–°æœ€å¤§å›æ’¤æŒ‡æ ‡ - åŸºäºæ¯æ—¥å‡€å€¼æ•°æ®
            if (dailyEquityData && dailyEquityData.length > 0) {
                const drawdown = calculateMaxDrawdownFromEquity(dailyEquityData);
                const maxDrawdownEl = document.getElementById('maxDrawdown');
                const maxDrawdownDaysEl = document.getElementById('maxDrawdownDays');

                if (maxDrawdownEl) {
                    maxDrawdownEl.textContent = `${drawdown.maxDrawdownPercent}%`;
                }
                if (maxDrawdownDaysEl) {
                    maxDrawdownDaysEl.textContent = `${drawdown.maxDrawdownDays}å¤©`;
                }
            }
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            try {
                const dataFile = getDataFileUrl();
                console.log('åŠ è½½æ•°æ®:', dataFile);

                const data = await loadJSON(dataFile);
                currentData = data;

                // æ˜¾ç¤ºä¸»å®¹å™¨
                document.getElementById('mainContainer').style.display = 'block';
                showLoading(false);

                // æ›´æ–°ç‰ˆæœ¬å·ï¼ˆä»…ç”¨äºæ§åˆ¶å°è¾“å‡ºï¼‰
                if (data.config && data.config.version) {
                    dataVersion = data.config.version;
                }

                // ä»tradesæ•°æ®ç”ŸæˆKçº¿æ•°æ®ï¼ˆç”¨äºå›¾è¡¨ï¼‰
                const klineData = generateKlineFromTrades(data.trades);

                // ä»tradesæ•°æ®ç”Ÿæˆå‡€å€¼æ•°æ®ï¼ˆç”¨äºå›¾è¡¨æ”¶ç›Šç‡æ›²çº¿ï¼‰
                const equityData = generateEquityData(data.trades);

                // ä»tradesæ•°æ®ç”Ÿæˆæ¯æ—¥ç»“æŸæ—¶çš„å‡€å€¼æ•°æ®ï¼ˆç”¨äºè®¡ç®—æœ€å¤§å›æ’¤ï¼‰
                const dailyEquityData = generateDailyEquityData(data.trades);

                // ä»å‡€å€¼æ•°æ®ç”Ÿæˆæ”¶ç›Šç™¾åˆ†æ¯”æ•°æ®ï¼ˆç”¨äºå›¾è¡¨æ”¶ç›Šç‡æ›²çº¿ï¼‰
                const returnsData = generateReturnsFromEquity(equityData);

                // åˆå§‹åŒ–å›¾è¡¨
                initCombinedChart(klineData, returnsData);

                // æ¸²æŸ“äº¤æ˜“è¡¨æ ¼
                renderTradeTable(data.trades);

                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                updateStats(data.trades, equityData, dailyEquityData);

                // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
                const lastUpdateEl = document.getElementById('lastUpdateTime');
                if (lastUpdateEl && data.config && data.config.lastUpdated) {
                    lastUpdateEl.textContent = data.config.lastUpdated;
                }

                // è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯åˆ°æ§åˆ¶å°ï¼ˆä¸æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼‰
                console.log(`âœ… æ•°æ®åŠ è½½æˆåŠŸ`);
                console.log(`ğŸ“¦ ç‰ˆæœ¬: ${dataVersion}`);
                console.log(`ğŸ• æœ€åæ›´æ–°: ${data.config ? data.config.lastUpdated : 'æœªçŸ¥'}`);

                return true;

            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                let errorMessage = 'æ— æ³•åŠ è½½æ•°æ®æ–‡ä»¶ã€‚';

                if (error.message.includes('404')) {
                    errorMessage = 'æ•°æ®æ–‡ä»¶æœªæ‰¾åˆ°ã€‚è¯·ç¡®ä¿data.jsonæ–‡ä»¶ä¸index.htmlåœ¨åŒä¸€ç›®å½•ä¸‹ã€‚';
                } else if (error.message.includes('Unexpected token')) {
                    errorMessage = 'æ•°æ®æ–‡ä»¶æ ¼å¼é”™è¯¯ã€‚è¯·æ£€æŸ¥data.jsonæ˜¯å¦ä¸ºæœ‰æ•ˆçš„JSONæ ¼å¼ã€‚';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ã€‚è¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’ŒæœåŠ¡å™¨è®¾ç½®ã€‚';
                }

                showError(errorMessage);
                return false;
            }
        }

        // å¼ºåˆ¶åˆ·æ–°æ•°æ®ï¼ˆç»•è¿‡æ‰€æœ‰ç¼“å­˜ï¼‰
        function forceRefreshData() {
            console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°æ•°æ®...');
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„ç¼“å­˜
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    cacheNames.forEach(cacheName => {
                        caches.delete(cacheName);
                    });
                });
            }

            // é‡æ–°åŠ è½½
            refreshData();
        }

        // åˆå§‹åŒ–é¡µé¢
        async function initPage() {
            try {
                // æ£€æŸ¥å…è´£å£°æ˜
                checkDisclaimer();

                // åŠ è½½äº¤æ˜“æ•°æ®
                await refreshData();

                // è®¾ç½®è‡ªåŠ¨æ›´æ–°
                if (currentData && currentData.config && currentData.config.autoUpdateInterval) {
                    console.log(`â° è®¾ç½®è‡ªåŠ¨æ›´æ–°é—´éš”: ${currentData.config.autoUpdateInterval}ms`);
                    setInterval(refreshData, currentData.config.autoUpdateInterval);
                }

            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            setTimeout(() => {
                initPage();
            }, 100);
        });
    </script>
</body>
</html>
