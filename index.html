<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰¹æ–¯æ‹‰(TSLA)æ¨¡æ‹Ÿäº¤æ˜“ç­–ç•¥è·Ÿè¸ª</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        #globalWarning {
            background: linear-gradient(90deg, #ff3b30, #ff6b6b);
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        #globalWarning button {
            margin-left: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 2px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 2.8rem;
            background: linear-gradient(90deg, #00c9ff, #92fe9d);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            background: rgba(40, 40, 40, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #4cd964;
            text-shadow: 0 0 10px rgba(76, 217, 100, 0.3);
        }

        .stat-label {
            font-size: 1rem;
            color: #aaa;
            margin-top: 5px;
        }

        .chart-container {
            display: flex;
            margin-bottom: 30px;
        }

        .chart-box {
            flex: 1;
            background: rgba(40, 40, 40, 0.8);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chart-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #fff;
            text-align: center;
        }

        .chart-title i {
            color: #4cd964;
        }

        .chart {
            height: 500px;
            width: 100%;
        }

        .data-table-container {
            background: rgba(40, 40, 40, 0.8);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 1.4rem;
            color: #fff;
            text-align: center;
            width: 100%;
        }

        .update-info {
            color: #aaa;
            font-size: 0.9rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: rgba(0, 0, 0, 0.5);
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            color: #fff;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .data-table td {
            padding: 14px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .buy-operation {
            color: #ff3b30;
            background: rgba(255, 59, 48, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .sell-operation {
            color: #4cd964;
            background: rgba(76, 217, 100, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .auto-update-status {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            font-size: 0.9rem;
            color: #aaa;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4cd964;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(76, 217, 100, 0.3);
            border-radius: 50%;
            border-top-color: #4cd964;
            animation: spin 1s linear infinite;
        }

        .error-message {
            background: rgba(255, 59, 48, 0.2);
            border: 1px solid rgba(255, 59, 48, 0.3);
            color: #ff3b30;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .timestamp-display {
            color: #aaa;
            font-size: 0.85rem;
        }

        .disclaimer-footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #777;
            font-size: 0.85rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .disclaimer-footer p {
            margin-top: 2px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.5;
        }

        #disclaimerModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            padding: 20px;
        }

        .modal-content {
            background: #2a2a2a;
            max-width: 1000px;
            width: 90%;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            color: #fff;
            position: relative;
            max-height: 800px;
            display: flex;
            flex-direction: column;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .modal-title {
            color: #ff3b30;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .modal-body {
            line-height: 1.6;
            overflow-y: auto;
            padding-right: 10px;
            flex: 1;
        }

        .modal-body p {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .modal-body strong {
            color: #4cd964;
            font-weight: 600;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .chart-container { flex-direction: column; }
            .stats-bar { flex-wrap: wrap; }
            .stat-item { flex: 0 0 33.33%; margin-bottom: 15px; }
            h1 { font-size: 2.2rem; }
            .chart { height: 400px; }
            .auto-update-status { flex-direction: column; align-items: center; text-align: center; }
            .modal-content { width: 95%; max-height: 80vh; padding: 20px; }
            .modal-title { font-size: 1.5rem; }
            .modal-body p { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div id="globalWarning">
        <i class="fas fa-exclamation-circle"></i>
        <strong>æ¨¡æ‹Ÿäº¤æ˜“å›æµ‹ç³»ç»Ÿ - ä¸æ„æˆæŠ•èµ„å»ºè®®</strong>
        <button onclick="showDisclaimerModal()">æŸ¥çœ‹å®Œæ•´å£°æ˜</button>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: flex;">
        <div class="loading-spinner"></div>
        <div style="color: #4cd964; margin-left: 20px;">æ­£åœ¨åŠ è½½æ•°æ®...</div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <header>
            <h1>ç‰¹æ–¯æ‹‰(TSLA)æ¨¡æ‹Ÿäº¤æ˜“ç­–ç•¥è·Ÿè¸ª</h1>
            <div class="auto-update-status">
                <span class="status-indicator"></span>
                <span>æœ€åæ›´æ–°: <span id="lastUpdateTime" class="timestamp-display">åŠ è½½ä¸­...</span></span>
            </div>
        </header>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="totalPnl">-</div>
                <div class="stat-label">æ€»æ”¶ç›Š</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="maxDrawdown">-</div>
                <div class="stat-label">æœ€å¤§å›æ’¤</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="maxDrawdownDays">-</div>
                <div class="stat-label">æœ€å¤§å›æ’¤å¤©æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalPositions">-</div>
                <div class="stat-label">æŒä»“æ•°é‡</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="tradeCount">-</div>
                <div class="stat-label">äº¤æ˜“æ¬¡æ•°</div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-box">
                <div class="chart-title">
                    <span><i class="fas fa-chart-candlestick"></i> ä»·æ ¼ä¸æ”¶ç›Š</span>
                </div>
                <div id="combinedChart" class="chart"></div>
            </div>
        </div>

        <div class="data-table-container">
            <div class="table-header">
                <h2 class="table-title">äº¤æ˜“è®°å½•</h2>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ (ç¾ä¸œæ—¶é—´)</th>
                        <th>å¼€ç›˜ä»·</th>
                        <th>æœ€é«˜ä»·</th>
                        <th>æœ€ä½ä»·</th>
                        <th>æ”¶ç›˜ä»·</th>
                        <th>æ“ä½œ</th>
                        <th>ç­–ç•¥</th>
                        <th>æŒä»“</th>
                        <th>ä»·æ ¼</th>
                        <th>å‡€å€¼</th>
                    </tr>
                </thead>
                <tbody id="tradeData">
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px;">æ­£åœ¨åŠ è½½äº¤æ˜“æ•°æ®...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="disclaimer-footer">
            <p>ç‰¹æ–¯æ‹‰(TSLA)æ¨¡æ‹Ÿäº¤æ˜“ç­–ç•¥è·Ÿè¸ª &copy; 2026</p>
            <p>
                <strong>é£é™©æç¤ºï¼š</strong>æœ¬å¹³å°æ‰€æœ‰æ•°æ®å‡ä¸ºæ¨¡æ‹Ÿå›æµ‹ç»“æœï¼Œä»…ä¾›ç ”ç©¶å‚è€ƒï¼Œå®é™…æŠ•èµ„å¯èƒ½å­˜åœ¨é‡å¤§å·®å¼‚ã€‚
            </p>
            <p>
                è‚¡å¸‚æŠ•èµ„å…·æœ‰é«˜é£é™©æ€§ï¼Œå¯èƒ½å¯¼è‡´æœ¬é‡‘æŸå¤±ã€‚æŠ•èµ„è€…åº”å……åˆ†äº†è§£ç›¸å…³é£é™©ï¼Œè°¨æ…å†³ç­–ã€‚å¹³å°ä¸å¯¹ä»»ä½•æŠ•èµ„å†³ç­–æˆ–ç»“æœè´Ÿè´£ã€‚
        </div>
    </div>

    <div id="disclaimerModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeDisclaimerModal()">âœ•</button>
            <h3 class="modal-title"><i class="fas fa-exclamation-triangle"></i> å…è´£å£°æ˜</h3>
            <div class="modal-body">
                <p><strong>1. æ€§è´¨è¯´æ˜</strong> æœ¬å¹³å°ä¸ºç‰¹æ–¯æ‹‰(TSLA)è‚¡ç¥¨çš„æ¨¡æ‹Ÿäº¤æ˜“ç­–ç•¥å›æµ‹å·¥å…·ï¼Œæ‰€æœ‰äº¤æ˜“å‡ä¸ºè™šæ‹Ÿæ¨¡æ‹Ÿï¼Œä¸æ¶‰åŠçœŸå®èµ„é‡‘ã€‚</p>
                <p><strong>2. éæŠ•èµ„å»ºè®®</strong> æ‰€æœ‰å±•ç¤ºçš„ç­–ç•¥ã€æ•°æ®å’Œå›¾è¡¨ä»…ä¸ºå†å²å›æµ‹ç»“æœï¼Œä¸æ„æˆä»»ä½•å½¢å¼çš„æŠ•èµ„å»ºè®®ã€æ¨èæˆ–æ‰¿è¯ºã€‚</p>
                <p><strong>3. é£é™©è­¦ç¤º</strong> å®é™…è‚¡ç¥¨å¸‚åœºæŠ•èµ„å…·æœ‰é«˜é£é™©ï¼Œå¯èƒ½å¯¼è‡´æœ¬é‡‘å…¨éƒ¨æŸå¤±ã€‚è¿‡å»è¡¨ç°ä¸ä»£è¡¨æœªæ¥æ”¶ç›Šã€‚</p>
                <p><strong>4. æ•°æ®å…è´£</strong> å¹³å°æ•°æ®æ¥æºäºå…¬å¼€å¸‚åœºä¿¡æ¯ï¼Œä¸ä¿è¯å‡†ç¡®æ€§ã€å®Œæ•´æ€§æˆ–åŠæ—¶æ€§ã€‚æ•°æ®ä»…ä¾›å‚è€ƒã€‚</p>
                <p><strong>5. è´£ä»»é™åˆ¶</strong> å¹³å°æ‰€æœ‰è€…ã€å¼€å‘è€…åŠç›¸å…³æ–¹ä¸å¯¹å› ä½¿ç”¨æœ¬å¹³å°æ•°æ®å¯¼è‡´çš„ä»»ä½•æŠ•èµ„æŸå¤±æ‰¿æ‹…è´£ä»»ã€‚</p>
                <p><strong>6. ç”¨æˆ·è´£ä»»</strong> ç”¨æˆ·åº”ç‹¬ç«‹åˆ¤æ–­ï¼Œè‡ªè´ŸæŠ•èµ„é£é™©ã€‚å»ºè®®å’¨è¯¢æŒç‰ŒæŠ•èµ„é¡¾é—®ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        let chartInstance = null;
        let currentData = null;
        let dataVersion = "1.0.0";
        let isSliding = false; // é˜²æ­¢é‡å¤æ»šåŠ¨çš„æ ‡å¿—
        let slideCooldown = false; // å†·å´æ ‡å¿—
        let lastWheelTime = 0; // ä¸Šæ¬¡æ»šè½®äº‹ä»¶æ—¶é—´
        let wheelSpeedFactor = 0; // æ»šè½®é€Ÿåº¦å› å­
        let cumulativeDelta = 0; // ç´¯ç§¯çš„æ»šåŠ¨é‡
        let lastUpdateTime = 0; // ä¸Šæ¬¡æ›´æ–°æ—¶é—´

        // å…è´£å£°æ˜ç›¸å…³
        function showDisclaimerModal() {
            document.getElementById('disclaimerModal').style.display = 'block';
        }

        function closeDisclaimerModal() {
            document.getElementById('disclaimerModal').style.display = 'none';
            document.cookie = "disclaimer_closed=true; max-age=86400; path=/";
        }

        function checkDisclaimer() {
            if (!document.cookie.includes('disclaimer_closed=true')) {
                setTimeout(() => {
                    document.getElementById('disclaimerModal').style.display = 'block';
                }, 1000);
            }
        }

        // è·å–æ•°æ®æ–‡ä»¶URL
        const getDataFileUrl = () => {
            return `./data.json?t=${Date.now()}`;
        };

        // æ˜¾ç¤º/éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
            }
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <h3><i class="fas fa-exclamation-triangle"></i> åŠ è½½æ•°æ®å¤±è´¥</h3>
                <p>${message}</p>
                <button onclick="location.reload()">åˆ·æ–°é¡µé¢</button>
            `;
            document.body.appendChild(errorDiv);
            showLoading(false);
        }

        // åŠ è½½JSONæ•°æ®
        async function loadJSON(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                throw error;
            }
        }

        // ä»tradesæ•°æ®ç”ŸæˆKçº¿æ•°æ®
        function generateKlineFromTrades(trades) {
            if (!trades || trades.length === 0) {
                return [];
            }

            const sortedTrades = [...trades].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });

            return sortedTrades.map(trade => {
                const dateStr = trade.date;
                let formattedDate = dateStr;

                if (dateStr && dateStr.length === 15) {
                    try {
                        const datePart = dateStr.substring(0, 8);
                        const timePart = dateStr.substring(9);
                        const year = datePart.substring(0, 4);
                        const month = datePart.substring(4, 6);
                        const day = datePart.substring(6, 8);
                        formattedDate = `${year}-${month}-${day} ${timePart}`;
                    } catch (e) {
                        console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', e);
                    }
                }

                return [
                    formattedDate,
                    Number(trade.open) || 0,
                    Number(trade.high) || 0,
                    Number(trade.low) || 0,
                    Number(trade.close) || 0
                ];
            });
        }

        // ä»tradesæ•°æ®ç”Ÿæˆå‡€å€¼æ•°æ®
        function generateEquityData(trades) {
            if (!trades || trades.length === 0) {
                return [];
            }

            const sortedTrades = [...trades].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });

            return sortedTrades.map(trade => {
                const dateStr = trade.date;
                let formattedDate = dateStr;

                if (dateStr && dateStr.length === 15) {
                    try {
                        const datePart = dateStr.substring(0, 8);
                        const timePart = dateStr.substring(9);
                        const year = datePart.substring(0, 4);
                        const month = datePart.substring(4, 6);
                        const day = datePart.substring(6, 8);
                        formattedDate = `${year}-${month}-${day} ${timePart}`;
                    } catch (e) {
                        console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', e);
                    }
                }

                return [
                    formattedDate,
                    Number(trade.equity) || 0
                ];
            });
        }

        // ä»tradesæ•°æ®ç”Ÿæˆæ¯æ—¥ç»“æŸæ—¶çš„å‡€å€¼æ•°æ®
        function generateDailyEquityData(trades) {
            if (!trades || trades.length === 0) {
                return [];
            }

            const sortedTrades = [...trades].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });

            const dailyEquityMap = new Map();

            sortedTrades.forEach(trade => {
                const dateStr = trade.date;
                let dateKey = '';

                if (dateStr) {
                    if (dateStr.length === 15) {
                        try {
                            const datePart = dateStr.substring(0, 8);
                            const year = datePart.substring(0, 4);
                            const month = datePart.substring(4, 6);
                            const day = datePart.substring(6, 8);
                            dateKey = `${year}-${month}-${day}`;
                        } catch (e) {
                            console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', e);
                        }
                    } else if (dateStr.length >= 10) {
                        try {
                            dateKey = dateStr.substring(0, 10);
                        } catch (e) {
                            console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', e);
                        }
                    }
                }

                if (dateKey) {
                    dailyEquityMap.set(dateKey, {
                        date: dateKey,
                        equity: Number(trade.equity) || 0
                    });
                }
            });

            return Array.from(dailyEquityMap.values())
                .sort((a, b) => a.date.localeCompare(b.date))
                .map(item => [item.date, item.equity]);
        }

        // ä»å‡€å€¼æ•°æ®ç”Ÿæˆæ”¶ç›Šç™¾åˆ†æ¯”æ•°æ®
        function generateReturnsFromEquity(equityData) {
            if (!equityData || equityData.length === 0) {
                return [];
            }

            const initialEquity = equityData[0][1];
            if (initialEquity <= 0) {
                return [];
            }

            return equityData.map(item => {
                const currentEquity = item[1];
                const returnPercent = ((currentEquity - initialEquity) / initialEquity * 100);
                return [
                    item[0],
                    parseFloat(returnPercent.toFixed(2))
                ];
            });
        }

        // è®¡ç®—æœ€å¤§å›æ’¤
        function calculateMaxDrawdownFromEquity(dailyEquityData) {
            if (!dailyEquityData || dailyEquityData.length < 2) {
                return { maxDrawdownPercent: 0, maxDrawdownDays: 0 };
            }

            let peak = dailyEquityData[0][1];
            let maxDrawdown = 0;
            let peakDate = dailyEquityData[0][0];
            let drawdownStartDate = dailyEquityData[0][0];
            let drawdownEndDate = dailyEquityData[0][0];

            for (let i = 1; i < dailyEquityData.length; i++) {
                const currentEquity = dailyEquityData[i][1];
                const currentDate = dailyEquityData[i][0];

                if (currentEquity > peak) {
                    peak = currentEquity;
                    peakDate = currentDate;
                } else {
                    const drawdown = (peak - currentEquity) / peak * 100;
                    if (drawdown > maxDrawdown) {
                        maxDrawdown = drawdown;
                        drawdownStartDate = peakDate;
                        drawdownEndDate = currentDate;
                    }
                }
            }

            let maxDrawdownDays = 0;
            try {
                const startDate = new Date(drawdownStartDate);
                const endDate = new Date(drawdownEndDate);
                const timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
                maxDrawdownDays = Math.ceil(timeDiff / (1000 * 3600 * 24));
                if (isNaN(maxDrawdownDays) || maxDrawdownDays < 0) {
                    maxDrawdownDays = 0;
                }
            } catch (e) {
                console.error('è®¡ç®—æœ€å¤§å›æ’¤å¤©æ•°é”™è¯¯:', e);
                maxDrawdownDays = 0;
            }

            return {
                maxDrawdownPercent: maxDrawdown.toFixed(2),
                maxDrawdownDays: maxDrawdownDays
            };
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                if (dateStr.length === 15) {
                    const datePart = dateStr.substring(0, 8);
                    const timePart = dateStr.substring(9);
                    const year = datePart.substring(0, 4);
                    const month = datePart.substring(4, 6);
                    const day = datePart.substring(6, 8);
                    return `${year}-${month}-${day} ${timePart}`;
                } else if (dateStr.length === 19) {
                    return dateStr;
                } else if (dateStr.includes('-')) {
                    return dateStr;
                } else {
                    console.warn('æœªçŸ¥æ—¥æœŸæ ¼å¼:', dateStr);
                    return dateStr;
                }
            } catch (e) {
                console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', e, 'åŸå§‹å­—ç¬¦ä¸²:', dateStr);
                return dateStr;
            }
        }

        // ç”Ÿæˆä¹°å–æ ‡è®°æ•°æ®
        function generateTradeMarkers(tradeRecords) {
            if (!tradeRecords || tradeRecords.length === 0) {
                return { buyMarkers: [], sellMarkers: [] };
            }

            const sortedTrades = [...tradeRecords].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });

            const buyMarkers = [];
            const sellMarkers = [];

            sortedTrades.forEach(trade => {
                const dateStr = trade.date;
                let formattedDate = dateStr;

                if (dateStr && dateStr.length === 15) {
                    try {
                        const datePart = dateStr.substring(0, 8);
                        const timePart = dateStr.substring(9);
                        const year = datePart.substring(0, 4);
                        const month = datePart.substring(4, 6);
                        const day = datePart.substring(6, 8);
                        formattedDate = `${year}-${month}-${day} ${timePart}`;
                    } catch (e) {
                        console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', e);
                    }
                }

                const closePrice = Number(trade.close) || 0;
                const lowPrice = Number(trade.low) || closePrice;
                const highPrice = Number(trade.high) || closePrice;

                if (trade.operation === 'BUY') {
                    const buyPosition = lowPrice - (lowPrice * 0.002);
                    buyMarkers.push({
                        value: [
                            formattedDate,
                            buyPosition,
                            'BUY',
                            'BUY',
                            closePrice.toFixed(2)
                        ]
                    });
                } else if (trade.operation === 'SELL') {
                    const sellPosition = highPrice + (highPrice * 0.002);
                    sellMarkers.push({
                        value: [
                            formattedDate,
                            sellPosition,
                            'SELL',
                            'SELL',
                            closePrice.toFixed(2)
                        ]
                    });
                }
            });

            console.log('ä¹°å…¥æ ‡è®°æ•°é‡:', buyMarkers.length);
            console.log('å–å‡ºæ ‡è®°æ•°é‡:', sellMarkers.length);

            return { buyMarkers, sellMarkers };
        }

        // åˆå§‹åŒ–åˆå¹¶å›¾è¡¨
        function initCombinedChart(klineData, returnsData, tradeRecords) {
            const chartDom = document.getElementById('combinedChart');
            if (!chartDom) {
                return null;
            }

            if (chartInstance) {
                chartInstance.dispose();
            }

            chartInstance = echarts.init(chartDom);

            if (!klineData || klineData.length === 0) {
                chartDom.innerHTML = '<div style="color: #aaa; text-align: center; padding: 50px;">æš‚æ— å›¾è¡¨æ•°æ®</div>';
                return null;
            }

            const klineSeriesData = klineData.map(item => [
                item[1] || 0,
                item[4] || 0,
                item[3] || 0,
                item[2] || 0
            ]);

            const timeData = klineData.map(item => item[0] || '');

            let returnsSeriesData = [];
            if (returnsData && returnsData.length > 0) {
                returnsSeriesData = returnsData.map(item => item[1] || 0);
            }

            const tradeMarkers = generateTradeMarkers(tradeRecords);

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        let result = '';
                        let operationType = '';
                        let markerData = null;

                        params.forEach(param => {
                            if (param.seriesType === 'candlestick') {
                                const dataIndex = param.dataIndex;
                                result += `<strong>${timeData[dataIndex]}</strong><br/>`;
                                result += `å¼€ç›˜: ${param.value[1]}<br/>`;
                                result += `æœ€é«˜: ${param.value[4]}<br/>`;
                                result += `æœ€ä½: ${param.value[3]}<br/>`;
                                result += `æ”¶ç›˜: ${param.value[2]}<br/>`;
                            } else if (param.seriesType === 'line') {
                                result += `æ”¶ç›Š: ${param.value.toFixed(2)}%<br/>`;
                            } else if (param.seriesType === 'scatter') {
                                if (param.data && param.data.length > 2) {
                                    markerData = param.data;
                                }
                            }
                        });

                        if (markerData) {
                            operationType = markerData[2] || markerData[3] || '';
                        }

                        if (operationType === 'BUY' || operationType === 'SELL') {
                            result += `æ“ä½œ: ${operationType}<br/>`;
                        }

                        return result;
                    }
                },
                legend: {
                    data: ['ä»·æ ¼', 'æ”¶ç›Š', 'ä¹°å…¥', 'å–å‡º'],
                    textStyle: { color: '#aaa' },
                    top: 10
                },
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: 0,
                        filterMode: 'filter',
                        zoomOnMouseWheel: true,  // å›¾è¡¨åŒºåŸŸå†…æ»šè½®ç¼©æ”¾
                        moveOnMouseWheel: true,  // å›¾è¡¨åŒºåŸŸå†…æ»šè½®å¹³ç§» - ç¦ç”¨ï¼Œç”¨è‡ªå®šä¹‰
                        moveOnMouseMove: true,    // å›¾è¡¨åŒºåŸŸå†…é¼ æ ‡æ‹–æ‹½å¹³ç§»
                        zoomLock: true,          // ç¦ç”¨ç¼©æ”¾
                        zoomSensitivity: 0.5,     // ç¼©æ”¾çµæ•åº¦ï¼Œå€¼è¶Šå°è¶Šæ…¢
                        start: Math.max(0, 100 - Math.min(70, klineData.length) / klineData.length * 100),
                        end: 100,
                        minValueSpan: Math.min(20, klineData.length),
                        maxValueSpan: Math.min(2000000, klineData.length)
                    },
                    {
                        type: 'slider',
                        xAxisIndex: 0,
                        show: true,
                        start: Math.max(0, 100 - Math.min(70, klineData.length) / klineData.length * 100),
                        end: 100,
                        bottom: 25,
                        height: 20,
                        backgroundColor: 'rgba(150, 150, 150, 0.2)',
                        borderColor: 'rgba(150, 150, 150, 0.3)',
                        fillerColor: 'rgba(150, 150, 150, 0.4)',
                        handleStyle: {
                            color: 'rgba(180, 180, 180, 0.8)',
                            borderColor: 'rgba(200, 200, 200, 0.8)',
                            borderWidth: 1
                        },
                        textStyle: { color: '#aaa' },
                        dataBackground: {
                            lineStyle: { opacity: 0 },
                            areaStyle: { opacity: 0 }
                        },
                        // ç¦ç”¨EChartsè‡ªå¸¦çš„æ»šè½®æ§åˆ¶
                        moveOnMouseWheel: false,
                        zoomOnMouseWheel: false,
                        brushSelect: false,
                        showDetail: false
                    }
                ],
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '20%',
                    top: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: timeData,
                    axisLine: { lineStyle: { color: '#aaa' } },
                    axisLabel: {
                        color: '#aaa',
                        fontSize: 10,
                        formatter: function(value) {
                            if (!value) return '';
                            const parts = value.split(' ');
                            if (parts.length > 1) {
                                return parts[0];
                            }
                            return value;
                        }
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        scale: true,
                        // name: 'ä»·æ ¼',
                        nameTextStyle: { color: '#aaa' },
                        axisLine: { lineStyle: { color: '#aaa' } },
                        axisLabel: { color: '#aaa', formatter: '{value}' },
                        splitLine: {
                            lineStyle: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                type: 'dashed'
                            }
                        }
                    },
                    {
                        type: 'value',
                        scale: true,
                        // name: 'æ”¶ç›Š(%)',
                        nameTextStyle: { color: '#aaa' },
                        axisLine: { lineStyle: { color: '#aaa' } },
                        axisLabel: { color: '#aaa', formatter: '{value}%' },
                        splitLine: { show: false },
                        position: 'right'
                    }
                ],
                series: [
                    {
                        name: 'ä»·æ ¼',
                        type: 'candlestick',
                        data: klineSeriesData,
                        itemStyle: {
                            color: '#ff3b30',
                            color0: '#4cd964',
                            borderColor: '#ff3b30',
                            borderColor0: '#4cd964',
                            borderWidth: 1
                        },
                        barWidth: 10,
                        barMinWidth: 6,
                        barMaxWidth: 12,
                        barCategoryGap: '40%',
                        yAxisIndex: 0
                    },
                    {
                        name: 'æ”¶ç›Š',
                        type: 'line',
                        yAxisIndex: 1,
                        data: returnsSeriesData,
                        smooth: true,
                        lineStyle: {
                            width: 3,
                            color: '#00c9ff'
                        },
                        itemStyle: {
                            color: '#00c9ff'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(0, 201, 255, 0.5)' },
                                { offset: 1, color: 'rgba(0, 201, 255, 0.1)' }
                            ])
                        }
                    },
                    {
                        name: 'ä¹°å…¥',
                        type: 'scatter',
                        data: tradeMarkers.buyMarkers.map(marker => marker.value),
                        symbol: 'circle',
                        symbolSize: 8,
                        symbolRotate: 0,
                        itemStyle: {
                            color: '#FF77A9',
                            borderWidth: 0
                        },
                        yAxisIndex: 0,
                        zlevel: 20
                    },
                    {
                        name: 'å–å‡º',
                        type: 'scatter',
                        data: tradeMarkers.sellMarkers.map(marker => marker.value),
                        symbol: 'circle',
                        symbolSize: 8,
                        symbolRotate: 0,
                        itemStyle: {
                            color: '#F0FFF0',
                            borderWidth: 1
                        },
                        yAxisIndex: 0,
                        zlevel: 20
                    }
                ]
            };

            chartInstance.setOption(option);

            // è‡ªå®šä¹‰æ»šè½®æ§åˆ¶é€»è¾‘
            setupCustomWheelControl(chartDom);

            window.addEventListener('resize', function() {
                chartInstance.resize();
            });

            return chartInstance;
        }

        // è®¾ç½®è‡ªå®šä¹‰æ»šè½®æ§åˆ¶
        function setupCustomWheelControl(chartDom) {
            const slider = chartDom.querySelector('.echarts-slider');
            if (!slider) {
                setTimeout(() => setupCustomWheelControl(chartDom), 100);
                return;
            }

            // ç¦ç”¨EChartsè‡ªå¸¦çš„æ»šè½®äº‹ä»¶
            chartDom.removeEventListener('wheel', chartDom._wheelHandler);

            // æ·»åŠ è‡ªå®šä¹‰æ»šè½®äº‹ä»¶ç›‘å¬
            slider.addEventListener('wheel', handleCustomWheel, { passive: false });

            // è®°å½•æ»šè½®å¤„ç†å™¨ä»¥ä¾¿åç»­ç§»é™¤
            chartDom._customWheelHandler = handleCustomWheel;
        }

        // è‡ªå®šä¹‰æ»šè½®å¤„ç†å‡½æ•°
        function handleCustomWheel(e) {
            e.preventDefault();
            e.stopPropagation();

            if (isSliding) return;

            const currentTime = Date.now();
            const timeDiff = currentTime - lastWheelTime;

            // æ§åˆ¶æ»šè½®äº‹ä»¶é¢‘ç‡
            if (timeDiff < 50) { // 50æ¯«ç§’å†·å´æ—¶é—´ï¼Œå¯è°ƒæ•´
                return;
            }

            lastWheelTime = currentTime;

            // è·å–å½“å‰dataZoomçš„startå’Œend
            const currentOption = chartInstance.getOption();
            const dataZoom = currentOption.dataZoom[1];

            if (!dataZoom || dataZoom.start === undefined || dataZoom.end === undefined) {
                return;
            }

            // è®¡ç®—æ»šè½®æ»šåŠ¨é‡ - ä½¿ç”¨æ›´çµæ•çš„ç®—æ³•
            let delta = 0;
            if (e.deltaMode === 0) { // åƒç´ æ¨¡å¼
                delta = e.deltaY * 0.001; // ç¼©æ”¾å› å­ï¼Œå¯è°ƒæ•´
            } else if (e.deltaMode === 1) { // è¡Œæ¨¡å¼
                delta = e.deltaY * 0.003; // ç¼©æ”¾å› å­ï¼Œå¯è°ƒæ•´
            } else { // é¡µé¢æ¨¡å¼
                delta = e.deltaY * 0.0010; // ç¼©æ”¾å› å­ï¼Œå¯è°ƒæ•´
            }

            // è®¡ç®—æ–°çš„startå’Œend
            let newStart = dataZoom.start - delta;
            let newEnd = dataZoom.end - delta;

            // è¾¹ç•Œæ£€æŸ¥ - é˜²æ­¢è¶…å‡ºèŒƒå›´
            if (newStart < 0) {
                newStart = 0;
                newEnd = Math.min(100, newEnd - newStart);
            }

            if (newEnd > 100) {
                newEnd = 100;
                newStart = Math.max(0, newStart - (newEnd - 100));
            }

            // ç¡®ä¿startå°äºend
            if (newStart >= newEnd) {
                if (delta > 0) {
                    newStart = newEnd - 1;
                } else {
                    newEnd = newStart + 1;
                }
            }

            // ç¡®ä¿èŒƒå›´åœ¨0-100ä¹‹é—´
            newStart = Math.max(0, Math.min(100, newStart));
            newEnd = Math.max(0, Math.min(100, newEnd));

            isSliding = true;

            // æ›´æ–°dataZoom
            chartInstance.dispatchAction({
                type: 'dataZoom',
                start: newStart,
                end: newEnd,
                dataZoomIndex: 1
            });

            // é‡ç½®æ»‘åŠ¨æ ‡å¿—
            setTimeout(() => {
                isSliding = false;
            }, 50);
        }

        // æ¸²æŸ“äº¤æ˜“è®°å½•è¡¨æ ¼
        function renderTradeTable(tradeRecords) {
            const tableBody = document.getElementById('tradeData');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            if (!tradeRecords || tradeRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">æš‚æ— äº¤æ˜“æ•°æ®</td></tr>';
                return;
            }

            // å…ˆæŒ‰æ—¶é—´ä»æ—©åˆ°æ™šæ’åº
            const timeSortedTrades = [...tradeRecords].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });

            // è¿‡æ»¤é‡å¤é¡¹ï¼šä»¥æ“ä½œ(operation)å’ŒæŒä»“(position)ä¸ºå‡†
            const uniqueRecords = [];

            for (let i = 0; i < timeSortedTrades.length; i++) {
                const currentRecord = timeSortedTrades[i];

                // å¦‚æœæ˜¯ç¬¬ä¸€æ¡è®°å½•ï¼Œæ€»æ˜¯æ·»åŠ 
                if (i === 0) {
                    uniqueRecords.push(currentRecord);
                    continue;
                }

                const prevRecord = timeSortedTrades[i - 1];

                // å¦‚æœæ“ä½œæˆ–ä»“ä½æœ‰å˜åŒ–ï¼Œæ·»åŠ åˆ°ç»“æœä¸­
                if (currentRecord.operation !== prevRecord.operation ||
                    currentRecord.position !== prevRecord.position) {
                    uniqueRecords.push(currentRecord);
                }
            }

            // æŒ‰æ—¥æœŸé™åºæ’åˆ—ç”¨äºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼‰
            const displayRecords = [...uniqueRecords].sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });

            displayRecords.forEach(record => {
                const row = document.createElement('tr');
                const operationClass = record.operation === 'BUY' ? 'buy-operation' : 'sell-operation';

                row.innerHTML = `
                    <td>${formatDate(record.date)}</td>
                    <td>${record.open !== undefined ? Number(record.open).toFixed(2) : '-'}</td>
                    <td>${record.high !== undefined ? Number(record.high).toFixed(2) : '-'}</td>
                    <td>${record.low !== undefined ? Number(record.low).toFixed(2) : '-'}</td>
                    <td>${record.close !== undefined ? Number(record.close).toFixed(2) : '-'}</td>
                    <td><span class="${operationClass}">${record.operation || '-'}</span></td>
                    <td>${record.strategy || '-'}</td>
                    <td>${record.position !== undefined ? record.position : '-'}</td>
                    <td>${record.price !== undefined ? Number(record.price).toFixed(2) : '-'}</td>
                    <td>${record.equity !== undefined ? Number(record.equity).toFixed(2) : '-'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats(tradeRecords, equityData, dailyEquityData) {
            if (!tradeRecords || tradeRecords.length === 0) {
                ['totalPnl', 'maxDrawdown', 'maxDrawdownDays', 'totalPositions', 'tradeCount'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = '-';
                });
                return;
            }

            const sortedTrades = [...tradeRecords].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });

            const firstRecord = sortedTrades[0];
            const latestRecord = sortedTrades[sortedTrades.length - 1];

            if (firstRecord.equity !== undefined && latestRecord.equity !== undefined) {
                const pnlEl = document.getElementById('totalPnl');
                if (pnlEl) {
                    const initialEquity = Number(firstRecord.equity);
                    const latestEquity = Number(latestRecord.equity);
                    if (initialEquity > 0) {
                        const totalReturn = ((latestEquity - initialEquity) / initialEquity * 100);
                        pnlEl.textContent = totalReturn.toFixed(2) + '%';
                    } else {
                        pnlEl.textContent = '0.00%';
                    }
                }
            }

            if (latestRecord.position !== undefined) {
                const positionsEl = document.getElementById('totalPositions');
                if (positionsEl) {
                    positionsEl.textContent = latestRecord.position.toString();
                }
            }

            const tradeCountEl = document.getElementById('tradeCount');
            if (tradeCountEl) {
                const uniqueRecords = [];
                const timeSortedTrades = [...tradeRecords].sort((a, b) => {
                    return new Date(a.date) - new Date(b.date);
                });

                for (let i = 0; i < timeSortedTrades.length; i++) {
                    const currentRecord = timeSortedTrades[i];
                    if (i === 0) {
                        uniqueRecords.push(currentRecord);
                        continue;
                    }
                    const prevRecord = timeSortedTrades[i - 1];
                    if (currentRecord.operation !== prevRecord.operation ||
                        currentRecord.position !== prevRecord.position) {
                        uniqueRecords.push(currentRecord);
                    }
                }
                tradeCountEl.textContent = uniqueRecords.length.toString();
            }

            if (dailyEquityData && dailyEquityData.length > 0) {
                const drawdown = calculateMaxDrawdownFromEquity(dailyEquityData);
                const maxDrawdownEl = document.getElementById('maxDrawdown');
                const maxDrawdownDaysEl = document.getElementById('maxDrawdownDays');
                if (maxDrawdownEl) {
                    maxDrawdownEl.textContent = `${drawdown.maxDrawdownPercent}%`;
                }
                if (maxDrawdownDaysEl) {
                    maxDrawdownDaysEl.textContent = `${drawdown.maxDrawdownDays}å¤©`;
                }
            }
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            try {
                const dataFile = getDataFileUrl();
                console.log('åŠ è½½æ•°æ®:', dataFile);

                const data = await loadJSON(dataFile);
                currentData = data;

                document.getElementById('mainContainer').style.display = 'block';
                showLoading(false);

                if (data.config && data.config.version) {
                    dataVersion = data.config.version;
                }

                const klineData = generateKlineFromTrades(data.trades);
                const equityData = generateEquityData(data.trades);
                const dailyEquityData = generateDailyEquityData(data.trades);
                const returnsData = generateReturnsFromEquity(equityData);

                initCombinedChart(klineData, returnsData, data.trades);
                renderTradeTable(data.trades);
                updateStats(data.trades, equityData, dailyEquityData);

                const lastUpdateEl = document.getElementById('lastUpdateTime');
                if (lastUpdateEl && data.config && data.config.lastUpdated) {
                    lastUpdateEl.textContent = data.config.lastUpdated;
                }

                console.log(`âœ… æ•°æ®åŠ è½½æˆåŠŸ`);
                console.log(`ğŸ“¦ ç‰ˆæœ¬: ${dataVersion}`);
                console.log(`ğŸ• æœ€åæ›´æ–°: ${data.config ? data.config.lastUpdated : 'æœªçŸ¥'}`);

                return true;
            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                let errorMessage = 'æ— æ³•åŠ è½½æ•°æ®æ–‡ä»¶ã€‚';
                if (error.message.includes('404')) {
                    errorMessage = 'æ•°æ®æ–‡ä»¶æœªæ‰¾åˆ°ã€‚è¯·ç¡®ä¿data.jsonæ–‡ä»¶ä¸index.htmlåœ¨åŒä¸€ç›®å½•ä¸‹ã€‚';
                } else if (error.message.includes('Unexpected token')) {
                    errorMessage = 'æ•°æ®æ–‡ä»¶æ ¼å¼é”™è¯¯ã€‚è¯·æ£€æŸ¥data.jsonæ˜¯å¦ä¸ºæœ‰æ•ˆçš„JSONæ ¼å¼ã€‚';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ã€‚è¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’ŒæœåŠ¡å™¨è®¾ç½®ã€‚';
                }
                showError(errorMessage);
                return false;
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        async function initPage() {
            try {
                checkDisclaimer();
                await refreshData();
                if (currentData && currentData.config && currentData.config.autoUpdateInterval) {
                    console.log(`â° è®¾ç½®è‡ªåŠ¨æ›´æ–°é—´éš”: ${currentData.config.autoUpdateInterval}ms`);
                    setInterval(refreshData, currentData.config.autoUpdateInterval);
                }
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            setTimeout(() => {
                initPage();
            }, 100);
        });
    </script>
</body>
</html>
